"""AI service for task analysis and suggestions"""
from typing import Dict, Any, List
from openai import AsyncOpenAI
from app.core.config import settings
from app.models.task import TimeScope, TaskPriority
from app.models.memory import Memory
import json


class TaskAIService:
    """Service for AI-powered task analysis"""

    def __init__(self):
        self.client = AsyncOpenAI(api_key=settings.OPENAI_API_KEY)

    async def analyze_task(self, title: str) -> Dict[str, Any]:
        """
        Analyze task title and suggest time_scope, priority, and category
        
        Args:
            title: Task title/description
            
        Returns:
            Dict with suggested time_scope, priority, confidence, and reasoning
        """
        system_prompt = """–¢—ã ‚Äî AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–¥–∞—á.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞: –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ –∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å:

1. **time_scope** (–≤—Ä–µ–º–µ–Ω–Ω–æ–π –º–∞—Å—à—Ç–∞–±):
   - "daily" - –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏ (—á–∏—Å—Ç–∫–∞ –∑—É–±–æ–≤, –∑–∞—Ä—è–¥–∫–∞, –≥–æ—Ç–æ–≤–∫–∞)
   - "weekly" - –Ω–µ–¥–µ–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏ (–ø–æ–∫—É–ø–∫–∏, —É–±–æ—Ä–∫–∞, –≤—Å—Ç—Ä–µ—á–∏)
   - "monthly" - –º–µ—Å—è—á–Ω—ã–µ –∑–∞–¥–∞—á–∏ (–æ–ø–ª–∞—Ç–∞ —Å—á–µ—Ç–æ–≤, –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ)
   - "long_term" - –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ —Ü–µ–ª–∏ (–≤—ã—É—á–∏—Ç—å —è–∑—ã–∫, –ø–æ—Ö—É–¥–µ—Ç—å, –∫–∞—Ä—å–µ—Ä–∞)

2. **priority** (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç):
   - "low" - –Ω–∏–∑–∫–∏–π (–º–æ–∂–Ω–æ –æ—Ç–ª–æ–∂–∏—Ç—å)
   - "medium" - —Å—Ä–µ–¥–Ω–∏–π (–æ–±—ã—á–Ω—ã–µ –∑–∞–¥–∞—á–∏)
   - "high" - –≤—ã—Å–æ–∫–∏–π (–≤–∞–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å —Å–∫–æ—Ä–æ)
   - "urgent" - —Å—Ä–æ—á–Ω–æ (–Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å —Å–µ–≥–æ–¥–Ω—è/—Å–µ–π—á–∞—Å)

3. **suggested_time** (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ HH:MM):
   - –î–ª—è –µ–∂–µ–¥–Ω–µ–≤–Ω—ã—Ö –∑–∞–¥–∞—á –ø—Ä–µ–¥–ª–∞–≥–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –≤—Ä–µ–º—è
   - –ü—Ä–∏–º–µ—Ä—ã: "08:00" (—É—Ç—Ä–µ–Ω–Ω–∏–µ –∑–∞–¥–∞—á–∏), "12:00" (–æ–±–µ–¥–µ–Ω–Ω—ã–µ), "20:00" (–≤–µ—á–µ—Ä–Ω–∏–µ)
   - –î–ª—è weekly/monthly/long_term - null

4. **suggested_due_date** (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è –¥–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è):
   - –î–ª—è daily –∑–∞–¥–∞—á: "today" –∏–ª–∏ "tomorrow"
   - –î–ª—è weekly –∑–∞–¥–∞—á: "this_week" (–≤ —Ç–µ—á–µ–Ω–∏–µ 7 –¥–Ω–µ–π)
   - –î–ª—è monthly –∑–∞–¥–∞—á: "this_month" (–≤ —Ç–µ—á–µ–Ω–∏–µ 30 –¥–Ω–µ–π)
   - –î–ª—è urgent –∑–∞–¥–∞—á: "today"
   - null - –µ—Å–ª–∏ –Ω–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å—Ä–æ–∫–∞
   
   –ü—Ä–∏–º–µ—Ä—ã:
   - "–ö—É–ø–∏—Ç—å –º–æ–ª–æ–∫–æ" ‚Üí "today"
   - "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ñ–∏–ª—å–º" ‚Üí "this_week"
   - "–û–ø–ª–∞—Ç–∏—Ç—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç" ‚Üí –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –¥–∞—Ç–∞ –µ—Å–ª–∏ –∏–∑–≤–µ—Å—Ç–Ω–æ, –∏–Ω–∞—á–µ "this_month"
   - "–ü–æ—á–∏—Å—Ç–∏—Ç—å –∑—É–±—ã" ‚Üí null (—Ä–µ–≥—É–ª—è—Ä–Ω–∞—è –∑–∞–¥–∞—á–∞)

5. **needs_deadline** (—Ç—Ä–µ–±—É–µ—Ç—Å—è –ª–∏ —Å—Ç—Ä–æ–≥–∏–π –¥–µ–¥–ª–∞–π–Ω):
   - true - –µ—Å–ª–∏ –∑–∞–¥–∞—á–∞ –∏–º–µ–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Å—Ä–æ–∫ (–æ–ø–ª–∞—Ç–∞ —Å—á–µ—Ç–æ–≤, –≤—Å—Ç—Ä–µ—á–∏, –¥–µ–¥–ª–∞–π–Ω—ã)
   - false - –¥–ª—è —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö –∑–∞–¥–∞—á –±–µ–∑ —Å—Ç—Ä–æ–≥–æ–≥–æ —Å—Ä–æ–∫–∞ (—á–∏—Å—Ç–∫–∞ –∑—É–±–æ–≤, –∑–∞—Ä—è–¥–∫–∞)

6. **is_recurring** (–ø–æ–≤—Ç–æ—Ä—è—é—â–∞—è—Å—è –ª–∏ –∑–∞–¥–∞—á–∞):
   - true - –µ—Å–ª–∏ –∑–∞–¥–∞—á–∞ –¥–æ–ª–∂–Ω–∞ –ø–æ–≤—Ç–æ—Ä—è—Ç—å—Å—è —Ä–µ–≥—É–ª—è—Ä–Ω–æ (—á–∏—Å—Ç–∫–∞ –∑—É–±–æ–≤, –∑–∞—Ä—è–¥–∫–∞, –¥—É—à, –µ–¥–∞, —Å–æ–Ω)
   - false - –µ—Å–ª–∏ –∑–∞–¥–∞—á–∞ –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–∞—è (–∫—É–ø–∏—Ç—å —á—Ç–æ-—Ç–æ, –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ñ–∏–ª—å–º, –≤—Å—Ç—Ä–µ—á–∞)
   
   –ü—Ä–∏–º–µ—Ä—ã recurring –∑–∞–¥–∞—á:
   - "–ü–æ—á–∏—Å—Ç–∏—Ç—å –∑—É–±—ã" ‚Üí true (–µ–∂–µ–¥–Ω–µ–≤–Ω–æ)
   - "–°—Ö–æ–¥–∏—Ç—å –≤ –¥—É—à" ‚Üí true (–µ–∂–µ–¥–Ω–µ–≤–Ω–æ)
   - "–£—Ç—Ä–µ–Ω–Ω—è—è –∑–∞—Ä—è–¥–∫–∞" ‚Üí true (–µ–∂–µ–¥–Ω–µ–≤–Ω–æ)
   - "–ü–æ–∑–∞–≤—Ç—Ä–∞–∫–∞—Ç—å" ‚Üí true (–µ–∂–µ–¥–Ω–µ–≤–Ω–æ)
   - "–í—ã–ø–∏—Ç—å –≤–æ–¥—É" ‚Üí true (–µ–∂–µ–¥–Ω–µ–≤–Ω–æ)
   
   –ü—Ä–∏–º–µ—Ä—ã –ù–ï recurring –∑–∞–¥–∞—á:
   - "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ù–∞—á–∞–ª–æ" ‚Üí false (–æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ)
   - "–ö—É–ø–∏—Ç—å –º–æ–ª–æ–∫–æ" ‚Üí false (–æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ)
   - "–ü–æ–∑–≤–æ–Ω–∏—Ç—å –º–∞–º–µ" ‚Üí false (–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ä–∞–∑)

7. **category** (–∫–∞—Ç–µ–≥–æ—Ä–∏—è, –µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ):
   - "movies" - —Ñ–∏–ª—å–º—ã, —Å–µ—Ä–∏–∞–ª—ã
   - "books" - –∫–Ω–∏–≥–∏, —á—Ç–µ–Ω–∏–µ
   - "places" - –º–µ—Å—Ç–∞ –¥–ª—è –ø–æ—Å–µ—â–µ–Ω–∏—è
   - "recipes" - –≥–æ—Ç–æ–≤–∫–∞, —Ä–µ—Ü–µ–ø—Ç—ã
   - "ideas" - –∏–¥–µ–∏, –º—ã—Å–ª–∏
   - "products" - –ø–æ–∫—É–ø–∫–∏
   - null - –µ—Å–ª–∏ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –Ω–∏ –æ–¥–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è

–ü—Ä–∏–º–µ—Ä—ã:
- "–ü–æ—á–∏—Å—Ç–∏—Ç—å –∑—É–±—ã" ‚Üí daily, medium, "08:00", null, false, true, null
- "–°—Ö–æ–¥–∏—Ç—å –≤ –¥—É—à" ‚Üí daily, medium, "08:00", null, false, true, null
- "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ù–∞—á–∞–ª–æ" ‚Üí weekly, medium, null, "this_week", false, false, movies
- "–ö—É–ø–∏—Ç—å –º–æ–ª–æ–∫–æ" ‚Üí daily, high, "18:00", "today", false, false, products
- "–û–ø–ª–∞—Ç–∏—Ç—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç" ‚Üí monthly, high, "10:00", "this_month", true, false, null
- "–ü–æ–∑–≤–æ–Ω–∏—Ç—å –º–∞–º–µ" ‚Üí daily, high, "19:00", "today", false, false, null
- "–£–±—Ä–∞—Ç—å—Å—è –≤ –∫–≤–∞—Ä—Ç–∏—Ä–µ" ‚Üí weekly, medium, null, "this_week", false, false, null

–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–π JSON –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞:
{
  "time_scope": "daily",
  "priority": "medium",
  "suggested_time": "08:00",
  "suggested_due_date": "today",
  "needs_deadline": false,
  "is_recurring": true,
  "category": "movies",
  "confidence": 0.95,
  "reasoning": "–ö—Ä–∞—Ç–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ"
}"""

        try:
            response = await self.client.chat.completions.create(
                model=settings.OPENAI_MODEL_CLASSIFICATION,
                messages=[
                    {"role": "system", "content": system_prompt},
                    {"role": "user", "content": f"–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∑–∞–¥–∞—á—É: {title}"}
                ],
                temperature=0.3,
                max_tokens=200,
            )

            content = response.choices[0].message.content.strip()
            
            # Parse JSON response
            result = json.loads(content)
            
            return {
                "time_scope": result.get("time_scope", "daily"),
                "priority": result.get("priority", "medium"),
                "suggested_time": result.get("suggested_time"),
                "suggested_due_date": result.get("suggested_due_date"),
                "needs_deadline": result.get("needs_deadline", False),
                "is_recurring": result.get("is_recurring", False),
                "category": result.get("category"),
                "confidence": result.get("confidence", 0.8),
                "reasoning": result.get("reasoning", "AI-–∞–Ω–∞–ª–∏–∑ –∑–∞–¥–∞—á–∏")
            }

        except Exception as e:
            print(f"‚ùå [TASK_AI] Error analyzing task: {e}")
            # Fallback to defaults
            return {
                "time_scope": "daily",
                "priority": "medium",
                "suggested_time": None,
                "suggested_due_date": None,
                "needs_deadline": False,
                "is_recurring": False,
                "category": None,
                "confidence": 0.5,
                "reasoning": "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å (–∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)"
            }

    async def suggest_tasks_from_memory(
        self,
        memory: Memory,
        limit: int = 3
    ) -> List[Dict[str, Any]]:
        """
        AI –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –∑–∞–¥–∞—á–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è
        
        Args:
            memory: –í–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
            limit: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
            
        Returns:
            –°–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á —Å confidence scores
        """
        # –ü–æ–ª—É—á–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é –µ—Å–ª–∏ –µ—Å—Ç—å
        category_name = memory.category.name if memory.category else "other"
        
        system_prompt = """–¢—ã ‚Äî AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Personal Memory & Planning.
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ—Ö—Ä–∞–Ω–∏–ª –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–µ. –¢–≤–æ—è –∑–∞–¥–∞—á–∞: –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å 2-3 —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –∑–∞–¥–∞—á–∏ –Ω–∞ –±—É–¥—É—â–µ–µ.

**–ü—Ä–∞–≤–∏–ª–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º:**

üìΩÔ∏è **movies** (—Ñ–∏–ª—å–º—ã/—Å–µ—Ä–∏–∞–ª—ã):
- –ü–æ—Ö–æ–∂–∏–µ —Ñ–∏–ª—å–º—ã —Ç–æ–≥–æ –∂–µ –∂–∞–Ω—Ä–∞
- –§–∏–ª—å–º—ã —Ç–æ–≥–æ –∂–µ —Ä–µ–∂–∏—Å—Å–µ—Ä–∞
- –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è/–ø—Ä–∏–∫–≤–µ–ª—ã
- –ü–æ—Ö–æ–∂–∏–µ –ø–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—é

üìö **books** (–∫–Ω–∏–≥–∏):
- –î—Ä—É–≥–∏–µ –∫–Ω–∏–≥–∏ –∞–≤—Ç–æ—Ä–∞
- –ü–æ—Ö–æ–∂–∏–µ –∫–Ω–∏–≥–∏ –ø–æ –∂–∞–Ω—Ä—É/—Ç–µ–º–µ
- –ö–Ω–∏–≥–∏ –∏–∑ —Ç–æ–π –∂–µ —Å–µ—Ä–∏–∏
- –ü–æ—Ö–æ–∂–∏–µ –ø–æ —Å—Ç–∏–ª—é

üìç **places** (–º–µ—Å—Ç–∞):
- –ü–æ—Ö–æ–∂–∏–µ –º–µ—Å—Ç–∞/—Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã
- –ú–µ—Å—Ç–∞ –ø–æ–±–ª–∏–∑–æ—Å—Ç–∏
- –ú–µ—Å—Ç–∞ —Å –ø–æ—Ö–æ–∂–µ–π –∫—É—Ö–Ω–µ–π/–∞—Ç–º–æ—Å—Ñ–µ—Ä–æ–π
- –î–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤ —Ç–æ–º –∂–µ –≥–æ—Ä–æ–¥–µ

üí° **ideas** (–∏–¥–µ–∏):
- –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —à–∞–≥–∏ –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
- –°–≤—è–∑–∞–Ω–Ω—ã–µ –∏–¥–µ–∏ –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è
- –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –¥–µ–π—Å—Ç–≤–∏—è
- –°–ª–µ–¥—É—é—â–∏–µ —ç—Ç–∞–ø—ã —Ä–∞–∑–≤–∏—Ç–∏—è –∏–¥–µ–∏

üç≥ **recipes** (—Ä–µ—Ü–µ–ø—Ç—ã):
- –ü–æ—Ö–æ–∂–∏–µ –±–ª—é–¥–∞
- –í–∞—Ä–∏–∞–Ω—Ç—ã —Ä–µ—Ü–µ–ø—Ç–∞
- –ë–ª—é–¥–∞ –∏–∑ —Ç–µ—Ö –∂–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤
- –ö–æ–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ä–Ω—ã–µ –±–ª—é–¥–∞

üõçÔ∏è **products** (—Ç–æ–≤–∞—Ä—ã):
- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã
- –ü–æ—Ö–æ–∂–∏–µ —Ç–æ–≤–∞—Ä—ã
- –°–æ–ø—É—Ç—Å—Ç–≤—É—é—â–∏–µ —Ç–æ–≤–∞—Ä—ã
- –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã

**–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:**
–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–π JSON –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞:
{
  "suggestions": [
    {
      "title": "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ò–Ω—Ç–µ—Ä—Å—Ç–µ–ª–ª–∞—Ä",
      "description": "–ü–æ—Ö–æ–∂–∏–π –Ω–∞—É—á–Ω–æ-—Ñ–∞–Ω—Ç–∞—Å—Ç–∏—á–µ—Å–∫–∏–π —Ñ–∏–ª—å–º –æ—Ç –ö—Ä–∏—Å—Ç–æ—Ñ–µ—Ä–∞ –ù–æ–ª–∞–Ω–∞",
      "time_scope": "weekly",
      "priority": "medium",
      "confidence": 0.95,
      "reasoning": "–¢–æ—Ç –∂–µ —Ä–µ–∂–∏—Å—Å–µ—Ä, –ø–æ—Ö–æ–∂–∏–π –∂–∞–Ω—Ä –∏ —Ç–µ–º—ã"
    }
  ]
}

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
- –ü—Ä–µ–¥–ª–æ–∂–∏ —Ä–æ–≤–Ω–æ 2-3 –∑–∞–¥–∞—á–∏ (–Ω–µ –±–æ–ª—å—à–µ, –Ω–µ –º–µ–Ω—å—à–µ)
- –ó–∞–¥–∞—á–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –∏ –¥–µ–π—Å—Ç–≤–µ–Ω–Ω—ã–º–∏
- –ò—Å–ø–æ–ª—å–∑—É–π —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫—É "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å X", "–ü—Ä–æ—á–∏—Ç–∞—Ç—å X", "–ü–æ—Å–µ—Ç–∏—Ç—å X"
- confidence –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 0.7 –¥–æ 1.0 (–ø—Ä–µ–¥–ª–∞–≥–∞–π —Ç–æ–ª—å–∫–æ —É–≤–µ—Ä–µ–Ω–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã)
- time_scope: daily/weekly/monthly/long_term
- priority: low/medium/high/urgent
- reasoning: –∫–æ—Ä–æ—Ç–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ (1 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ)

–ü—Ä–∏–º–µ—Ä—ã:

1. –í–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–µ: "–ü–æ—Å–º–æ—Ç—Ä–µ–ª –ù–∞—á–∞–ª–æ" (movies)
‚Üí –ü—Ä–µ–¥–ª–æ–∂–∏: "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ò–Ω—Ç–µ—Ä—Å—Ç–µ–ª–ª–∞—Ä", "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ü—Ä–µ—Å—Ç–∏–∂", "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ü–æ–º–Ω–∏"

2. –í–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–µ: "–ü—Ä–æ—á–∏—Ç–∞–ª 1984" (books)
‚Üí –ü—Ä–µ–¥–ª–æ–∂–∏: "–ü—Ä–æ—á–∏—Ç–∞—Ç—å –°–∫–æ—Ç–Ω—ã–π –¥–≤–æ—Ä", "–ü—Ä–æ—á–∏—Ç–∞—Ç—å –û –¥–∏–≤–Ω—ã–π –Ω–æ–≤—ã–π –º–∏—Ä", "–ü—Ä–æ—á–∏—Ç–∞—Ç—å 451 –≥—Ä–∞–¥—É—Å –ø–æ –§–∞—Ä–µ–Ω–≥–µ–π—Ç—É"

3. –í–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–µ: "–ü–æ—Å–µ—Ç–∏–ª —Ä–µ—Å—Ç–æ—Ä–∞–Ω –∏—Ç–∞–ª—å—è–Ω—Å–∫–æ–π –∫—É—Ö–Ω–∏ X" (places)
‚Üí –ü—Ä–µ–¥–ª–æ–∂–∏: "–ü–æ—Å–µ—Ç–∏—Ç—å —Ä–µ—Å—Ç–æ—Ä–∞–Ω Y", "–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Ä–µ—Å—Ç–æ—Ä–∞–Ω Z", "–°—Ö–æ–¥–∏—Ç—å –≤ —Ç—Ä–∞—Ç—Ç–æ—Ä–∏—è A"

4. –í–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–µ: "–ò–¥–µ—è: —Å–æ–∑–¥–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è X" (ideas)
‚Üí –ü—Ä–µ–¥–ª–æ–∂–∏: "–ò–∑—É—á–∏—Ç—å —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –¥–ª—è X", "–ù–∞–±—Ä–æ—Å–∞—Ç—å –ø—Ä–æ—Ç–æ—Ç–∏–ø", "–ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤"
"""

        user_prompt = f"""–í–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–µ:
–ö–∞—Ç–µ–≥–æ—Ä–∏—è: {category_name}
–ù–∞–∑–≤–∞–Ω–∏–µ: {memory.title}
–û–ø–∏—Å–∞–Ω–∏–µ: {memory.content[:500]}

–ü—Ä–µ–¥–ª–æ–∂–∏ {limit} —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –∑–∞–¥–∞—á–∏ –Ω–∞ –±—É–¥—É—â–µ–µ."""

        try:
            print(f"ü§ñ [TASK_AI] Generating suggestions for memory: {memory.title}")
            
            response = await self.client.chat.completions.create(
                model=settings.OPENAI_MODEL_CLASSIFICATION,
                messages=[
                    {"role": "system", "content": system_prompt},
                    {"role": "user", "content": user_prompt}
                ],
                temperature=0.7,  # –ù–µ–º–Ω–æ–≥–æ –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç–∏
                max_tokens=800,
            )

            content = response.choices[0].message.content.strip()
            print(f"ü§ñ [TASK_AI] Raw response: {content[:200]}...")
            
            # Parse JSON response
            result = json.loads(content)
            suggestions = result.get("suggestions", [])
            
            print(f"‚úÖ [TASK_AI] Generated {len(suggestions)} suggestions")
            
            # Validate and filter suggestions
            valid_suggestions = []
            for suggestion in suggestions[:limit]:
                if all(key in suggestion for key in ["title", "description", "time_scope", "priority"]):
                    valid_suggestions.append({
                        "title": suggestion["title"],
                        "description": suggestion["description"],
                        "time_scope": suggestion["time_scope"],
                        "priority": suggestion["priority"],
                        "confidence": suggestion.get("confidence", 0.8),
                        "reasoning": suggestion.get("reasoning", "AI —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è"),
                        "category": category_name if category_name != "other" else None
                    })
            
            return valid_suggestions

        except Exception as e:
            print(f"‚ùå [TASK_AI] Error generating suggestions: {e}")
            # Return empty list on error
            return []

    async def analyze_habit(self, title: str) -> Dict[str, Any]:
        """
        Analyze habit/goal and generate suggested subtasks
        
        Args:
            title: Habit/goal title (e.g., "–ë—Ä–æ—Å–∏—Ç—å –∫—É—Ä–∏—Ç—å", "–ù–∞—á–∞—Ç—å –±–µ–≥–∞—Ç—å")
            
        Returns:
            Dict with group_name, group_icon, subtasks list, confidence, reasoning
        """
        system_prompt = """–¢—ã ‚Äî AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏–≤—ã—á–µ–∫ –∏ —Ü–µ–ª–µ–π.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞: –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—É—é —Ü–µ–ª—å/–ø—Ä–∏–≤—ã—á–∫—É –∏ —Å–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É –µ–∂–µ–¥–Ω–µ–≤–Ω—ã—Ö –ø–æ–¥–∑–∞–¥–∞—á –¥–ª—è –µ—ë –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è.

**–ü—Ä–∞–≤–∏–ª–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ–¥–∑–∞–¥–∞—á:**

1. **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ**: –°–æ–∑–¥–∞–≤–∞–π 4-6 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø–æ–¥–∑–∞–¥–∞—á
2. **–ß–∞—Å—Ç–æ—Ç–∞**: –ë–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–º–∏ (is_recurring: true)
3. **–†–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ**: –§–∏–∑–∏—á–µ—Å–∫–∏–µ + –º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ + –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –¥–µ–π—Å—Ç–≤–∏—è
4. **–í—Ä–µ–º—è**: –†–∞—Å–ø—Ä–µ–¥–µ–ª–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫ (—É—Ç—Ä–æ, –¥–µ–Ω—å, –≤–µ—á–µ—Ä)
5. **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã**: –í–∞—Ä—å–∏—Ä—É–π –æ—Ç low –¥–æ high
6. **–¶–≤–µ—Ç–∞**: –ò—Å–ø–æ–ª—å–∑—É–π hex-—Ü–≤–µ—Ç–∞ –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è
7. **–ò–∫–æ–Ω–∫–∏**: –ò—Å–ø–æ–ª—å–∑—É–π Ionicons (—Ñ–æ—Ä–º–∞—Ç: "Ionicons.icon_name_outline")

**–ü—Ä–∏–º–µ—Ä—ã –ø—Ä–∏–≤—ã—á–µ–∫ –∏ –ø–æ–¥–∑–∞–¥–∞—á:**

üö≠ "–ë—Ä–æ—Å–∏—Ç—å –∫—É—Ä–∏—Ç—å":
- "–í—ã–ø–∏—Ç—å —Å—Ç–∞–∫–∞–Ω –≤–æ–¥—ã" (—É—Ç—Ä–æ, 08:00, blue, water, medium)
- "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–ª–∞—Å—Ç—ã—Ä—å" (—É—Ç—Ä–æ, 09:00, green, medical, high)
- "–î—ã—Ö–∞—Ç–µ–ª—å–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è" (–¥–µ–Ω—å, 14:00, purple, leaf, medium)
- "–ü—Ä–æ–≥—É–ª–∫–∞ –Ω–∞ —Å–≤–µ–∂–µ–º –≤–æ–∑–¥—É—Ö–µ" (–≤–µ—á–µ—Ä, 18:00, orange, walk, medium)
- "–ó–∞–Ω—è—Ç—å —Ä—É–∫–∏ –¥–µ–ª–æ–º" (–ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏, –ª—é–±–æ–µ –≤—Ä–µ–º—è, yellow, hand, low)

üèÉ "–ù–∞—á–∞—Ç—å –±–µ–≥–∞—Ç—å":
- "–£—Ç—Ä–µ–Ω–Ω—è—è —Ä–∞—Å—Ç—è–∂–∫–∞" (—É—Ç—Ä–æ, 07:00, purple, body, medium)
- "–ü—Ä–æ–±–µ–∂–∫–∞ 2-3 –∫–º" (—É—Ç—Ä–æ, 07:30, red, fitness, high)
- "–í—ã–ø–∏—Ç—å –≤–æ–¥—ã –ø–æ—Å–ª–µ –ø—Ä–æ–±–µ–∂–∫–∏" (—É—Ç—Ä–æ, 08:30, blue, water, high)
- "–õ–µ–≥–∫–∏–π –ø–µ—Ä–µ–∫—É—Å" (—É—Ç—Ä–æ, 09:00, green, restaurant, medium)

‚öñÔ∏è "–ü–æ—Ö—É–¥–µ—Ç—å / –ó–¥–æ—Ä–æ–≤–æ–µ –ø–∏—Ç–∞–Ω–∏–µ":
- "–ó–¥–æ—Ä–æ–≤—ã–π –∑–∞–≤—Ç—Ä–∞–∫" (—É—Ç—Ä–æ, 08:00, green, restaurant, high)
- "–í—ã–ø–∏—Ç—å 2–ª –≤–æ–¥—ã" (–≤–µ—Å—å –¥–µ–Ω—å, null, blue, water, medium)
- "–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ 30 –º–∏–Ω" (–≤–µ—á–µ—Ä, 18:00, red, fitness, high)
- "–û—Ç–∫–∞–∑–∞—Ç—å—Å—è –æ—Ç —Å–ª–∞–¥–∫–æ–≥–æ" (–≤–µ—Å—å –¥–µ–Ω—å, null, orange, close_circle, medium)
- "–í–µ—á–µ—Ä–Ω—è—è –ø—Ä–æ–≥—É–ª–∫–∞" (–≤–µ—á–µ—Ä, 20:00, purple, walk, low)

üìö "–í—ã—É—á–∏—Ç—å –∞–Ω–≥–ª–∏–π—Å–∫–∏–π":
- "Duolingo 15 –º–∏–Ω—É—Ç" (—É—Ç—Ä–æ, 09:00, green, language, high)
- "–ü—Ä–æ—á–∏—Ç–∞—Ç—å —Ç–µ–∫—Å—Ç" (–¥–µ–Ω—å, 14:00, blue, book, medium)
- "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤–∏–¥–µ–æ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º" (–≤–µ—á–µ—Ä, 19:00, red, play, medium)
- "–í—ã–ø–∏—Å–∞—Ç—å –Ω–æ–≤—ã–µ —Å–ª–æ–≤–∞" (–≤–µ—á–µ—Ä, 20:00, purple, create, low)

**–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ü–≤–µ—Ç–∞ (hex):**
- –ö—Ä–∞—Å–Ω—ã–π: #EF4444 (—Å—Ä–æ—á–Ω–æ, –≤–∞–∂–Ω–æ)
- –û—Ä–∞–Ω–∂–µ–≤—ã–π: #F97316 (–≤–∞–∂–Ω–æ)
- –ñ–µ–ª—Ç—ã–π: #FBBF24 (–≤–Ω–∏–º–∞–Ω–∏–µ)
- –ó–µ–ª–µ–Ω—ã–π: #10B981 (–∑–¥–æ—Ä–æ–≤—å–µ, —Ä–æ—Å—Ç)
- –°–∏–Ω–∏–π: #3B82F6 (–≤–æ–¥–∞, —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ)
- –§–∏–æ–ª–µ—Ç–æ–≤—ã–π: #8B5CF6 (–¥—É—Ö–æ–≤–Ω–æ–µ, –º–µ–¥–∏—Ç–∞—Ü–∏—è)
- –†–æ–∑–æ–≤—ã–π: #EC4899 (–∑–∞–±–æ—Ç–∞ –æ —Å–µ–±–µ)

**–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∏–∫–æ–Ω–∫–∏ Ionicons:**
- water_outline (–≤–æ–¥–∞)
- fitness_outline (—Å–ø–æ—Ä—Ç)
- restaurant_outline (–µ–¥–∞)
- book_outline (—á—Ç–µ–Ω–∏–µ)
- walk_outline (–ø—Ä–æ–≥—É–ª–∫–∞)
- leaf_outline (–º–µ–¥–∏—Ç–∞—Ü–∏—è, –¥—ã—Ö–∞–Ω–∏–µ)
- heart_outline (–∑–¥–æ—Ä–æ–≤—å–µ)
- sparkles_outline (–ø—Ä–∏–≤—ã—á–∫–∏)
- time_outline (–≤—Ä–µ–º—è)
- checkmark_circle_outline (–≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ)
- close_circle_outline (–æ—Ç–∫–∞–∑ –æ—Ç —á–µ–≥–æ-—Ç–æ)
- add_circle_outline (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ)
- create_outline (—Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ)
- language_outline (—è–∑—ã–∫–∏)
- play_outline (–≤–∏–¥–µ–æ)
- musical_notes_outline (–º—É–∑—ã–∫–∞)
- body_outline (—Ç–µ–ª–æ, —Ä–∞—Å—Ç—è–∂–∫–∞)
- medical_outline (–ª–µ–∫–∞—Ä—Å—Ç–≤–∞, –∑–¥–æ—Ä–æ–≤—å–µ)
- bed_outline (—Å–æ–Ω)
- sunny_outline (—É—Ç—Ä–æ)
- moon_outline (–≤–µ—á–µ—Ä)

**–ì—Ä—É–ø–ø–∞:**
- group_name: –ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã (–æ–±—ã—á–Ω–æ = –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–≤—ã—á–∫–∏)
- group_icon: Emoji –¥–ª—è –≥—Ä—É–ø–ø—ã (üö≠, üèÉ, ‚öñÔ∏è, üìö, üí™, üßò, üéØ, etc.)

–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–π JSON –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞:
{
  "group_name": "–ë—Ä–æ—Å–∏—Ç—å –∫—É—Ä–∏—Ç—å",
  "group_icon": "üö≠",
  "subtasks": [
    {
      "title": "–í—ã–ø–∏—Ç—å —Å—Ç–∞–∫–∞–Ω –≤–æ–¥—ã",
      "description": "–ü–æ–º–æ–≥–∞–µ—Ç —Å–Ω–∏–∑–∏—Ç—å —Ç—è–≥—É –∫ –∫—É—Ä–µ–Ω–∏—é",
      "priority": "medium",
      "suggested_time": "08:00",
      "color": "#3B82F6",
      "icon": "Ionicons.water_outline",
      "is_recurring": true
    },
    {
      "title": "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–ª–∞—Å—Ç—ã—Ä—å",
      "description": "–ù–∏–∫–æ—Ç–∏–Ω–æ–≤—ã–π –ø–ª–∞—Å—Ç—ã—Ä—å –Ω–∞ –¥–µ–Ω—å",
      "priority": "high",
      "suggested_time": "09:00",
      "color": "#10B981",
      "icon": "Ionicons.medical_outline",
      "is_recurring": true
    }
  ],
  "confidence": 0.95,
  "reasoning": "–ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –ø–æ–¥—Ö–æ–¥: —Ñ–∏–∑–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –∏ –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –º–µ—Ç–æ–¥—ã"
}

**–í–∞–∂–Ω–æ:**
- –í—Å–µ –ø–æ–¥–∑–∞–¥–∞—á–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –∏ –¥–µ–π—Å—Ç–≤–µ–Ω–Ω—ã–º–∏
- –û–ø–∏—Å–∞–Ω–∏—è –¥–æ–ª–∂–Ω—ã –æ–±—ä—è—Å–Ω—è—Ç—å, –∑–∞—á–µ–º –Ω—É–∂–Ω–∞ –ø–æ–¥–∑–∞–¥–∞—á–∞
- is_recurring –ø–æ—á—Ç–∏ –≤—Å–µ–≥–¥–∞ true –¥–ª—è –ø—Ä–∏–≤—ã—á–µ–∫
- suggested_time –≤ —Ñ–æ—Ä–º–∞—Ç–µ HH:MM –∏–ª–∏ null
- –¶–≤–µ—Ç–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ hex-—Ñ–æ—Ä–º–∞—Ç–µ —Å # (–Ω–∞–ø—Ä–∏–º–µ—Ä, #3B82F6)
- –ò–∫–æ–Ω–∫–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ "Ionicons.icon_name_outline"
"""

        user_prompt = f"–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø—Ä–∏–≤—ã—á–∫—É/—Ü–µ–ª—å –∏ —Å–æ–∑–¥–∞–π –≥—Ä—É–ø–ø—É –ø–æ–¥–∑–∞–¥–∞—á: {title}"

        try:
            print(f"ü§ñ [TASK_AI] Analyzing habit: {title}")
            
            response = await self.client.chat.completions.create(
                model=settings.OPENAI_MODEL_CLASSIFICATION,
                messages=[
                    {"role": "system", "content": system_prompt},
                    {"role": "user", "content": user_prompt}
                ],
                temperature=0.7,  # –ù–µ–∫–æ—Ç–æ—Ä–∞—è –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å
                max_tokens=1500,
            )

            content = response.choices[0].message.content.strip()
            print(f"ü§ñ [TASK_AI] Raw response: {content[:200]}...")
            
            # Parse JSON response
            result = json.loads(content)
            
            print(f"‚úÖ [TASK_AI] Generated {len(result.get('subtasks', []))} subtasks")
            
            return {
                "group_name": result.get("group_name", title),
                "group_icon": result.get("group_icon", "üéØ"),
                "subtasks": result.get("subtasks", []),
                "confidence": result.get("confidence", 0.8),
                "reasoning": result.get("reasoning", "AI-–∞–Ω–∞–ª–∏–∑ –ø—Ä–∏–≤—ã—á–∫–∏")
            }

        except Exception as e:
            print(f"‚ùå [TASK_AI] Error analyzing habit: {e}")
            # Return minimal response
            return {
                "group_name": title,
                "group_icon": "üéØ",
                "subtasks": [],
                "confidence": 0.5,
                "reasoning": "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä—É—á–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ)"
            }
