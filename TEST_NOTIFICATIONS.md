# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ Celery Beat Schedule

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ `celery_app.py` –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –≤—Å–µ –∑–∞–¥–∞—á–∏:

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
cd backend
python3 -c "from app.tasks.celery_app import celery_app; print(celery_app.conf.beat_schedule)"
```

–î–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã:
- ‚úÖ `check-task-reminders` - –∫–∞–∂–¥—ã–π —á–∞—Å
- ‚úÖ `send-daily-task-summary` - –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 8:00
- ‚úÖ `check-overdue-tasks` - –∫–∞–∂–¥—ã–µ 4 —á–∞—Å–∞
- ‚úÖ `check-pet-health` - –∫–∞–∂–¥—ã–µ 12 —á–∞—Å–æ–≤
- ‚úÖ `send-throwback-notifications` - –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 9:00

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ Docker Compose

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ `docker-compose.yml` –∏ `docker-compose.prod.yml` –µ—Å—Ç—å —Å–µ—Ä–≤–∏—Å `celery_beat`:

```yaml
celery_beat:
  build: .
  command: celery -A app.tasks.celery_app beat --loglevel=info
  ...
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–∏–≤—ã—á–µ–∫

–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø—Ä–∏–≤—ã—á–∫–∏ —Å `scheduled_time` (–Ω–∞–ø—Ä–∏–º–µ—Ä, "08:00"), `due_date` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Å –≤—Ä–µ–º–µ–Ω–µ–º:

```python
# –ü—Ä–∞–≤–∏–ª—å–Ω–æ:
due_date = datetime(2026, 1, 19, 8, 0, tzinfo=timezone.utc)  # 2026-01-19 08:00:00

# –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ:
due_date = datetime(2026, 1, 19, 0, 0, tzinfo=timezone.utc)  # 2026-01-19 00:00:00
```

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

–õ–æ–≥–∏–∫–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π:
- –û–∫–Ω–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è: ¬±30 –º–∏–Ω—É—Ç –æ—Ç –≤—Ä–µ–º–µ–Ω–∏ `reminder_time = now + reminder_hours_before`
- –ï—Å–ª–∏ –∑–∞–¥–∞—á–∞ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –æ–∫–Ω–æ, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è
- –ß—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç–æ–≤, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è `updated_at < now - 55 –º–∏–Ω—É—Ç`

### 5. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ

1. **–ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã:**
```bash
cd backend
docker-compose up -d
```

2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ Celery Beat –∑–∞–ø—É—â–µ–Ω:**
```bash
docker-compose logs celery_beat
```

–î–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:
```
celery beat v5.x.x is starting.
```

3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∑–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è:**
```bash
docker-compose logs celery_worker
```

4. **–°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –ø—Ä–∏–≤—ã—á–∫—É —á–µ—Ä–µ–∑ API:**
```bash
curl -X POST http://localhost:8000/api/v1/tasks/create-habit \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "habit_name": "–¢–µ—Å—Ç–æ–≤–∞—è –ø—Ä–∏–≤—ã—á–∫–∞",
    "group_icon": "üß™",
    "subtasks": [{
      "title": "–¢–µ—Å—Ç–æ–≤–∞—è –∑–∞–¥–∞—á–∞",
      "description": "–ü—Ä–æ–≤–µ—Ä–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π",
      "priority": "medium",
      "suggested_time": "08:00",
      "color": "#3B82F6",
      "icon": "Ionicons.checkmark",
      "is_recurring": true
    }]
  }'
```

5. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö, —á—Ç–æ `due_date` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ:**
```sql
SELECT id, title, due_date, scheduled_time 
FROM tasks 
WHERE title = '–¢–µ—Å—Ç–æ–≤–∞—è –∑–∞–¥–∞—á–∞';
```

`due_date` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å –≤—Ä–µ–º–µ–Ω–µ–º 08:00, –∞ –Ω–µ 00:00.

6. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∑–∞–¥–∞—á–∞ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –æ–∫–Ω–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è:**
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –∑–∞–¥–∞—á—É –≤—Ä—É—á–Ω—É—é –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
docker-compose exec celery_worker celery -A app.tasks.celery_app call check_task_reminders
```

### 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ Firebase

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ:
- ‚úÖ `FIREBASE_CREDENTIALS_PATH` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ `.env`
- ‚úÖ –§–∞–π–ª —Å credentials —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- ‚úÖ Firebase Admin SDK –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω (–ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ backend)

### 7. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
- ‚úÖ `task_reminders_enabled = True`
- ‚úÖ `fcm_token` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (–Ω–µ NULL)
- ‚úÖ `reminder_hours_before` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1)

## üö® –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

1. **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç:**
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ Celery Beat –∑–∞–ø—É—â–µ–Ω
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `due_date` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Å –≤—Ä–µ–º–µ–Ω–µ–º (–Ω–µ 00:00:00)
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∑–∞–¥–∞—á–∞ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –æ–∫–Ω–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ Celery Worker

2. **–î—É–±–ª–∏–∫–∞—Ç—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:**
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏–∫—É `updated_at < min_update_time`
   - –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è `updated_at` –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è

3. **Celery Beat –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è:**
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Å–µ—Ä–≤–∏—Å `celery_beat` –¥–æ–±–∞–≤–ª–µ–Ω –≤ docker-compose
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏: `docker-compose logs celery_beat`

## üìù –ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è

1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ Celery Beat –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
2. –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –ø—Ä–∏–≤—ã—á–∫—É –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –¥—É–±–ª–∏—Ä—É—é—Ç—Å—è
